
# mbedTLS
`mbedTLS`是一个轻量级的开源加密库,广泛用于嵌入式系统中,它提供了`TLS(传输层安全性)`协议的实现,用于在不安全的网络上确保数据的机密性和完整性.

## 目录
- [1. TLS协议概述](#1-tls协议概述)
  - [1.1 TLS连接的基本过程](#11-tls连接的基本过程)
- [2. mbedTLS与远程建立连接的流程](#2-mbedtls与远程建立连接的流程)
  - [2.1 初始化和配置](#21-初始化和配置)
  - [2.2 握手过程](#22-握手过程)
    - [2.2.1 客户端发起连接](#221-客户端发起连接)
    - [2.2.2 客户端发送ClientHello消息](#222-客户端发送clienthello消息)
    - [2.2.3 服务器响应ServerHello消息](#223-服务器响应serverhello消息)
    - [2.2.4 证书验证和密钥交换](#224-证书验证和密钥交换)
    - [2.2.5 完成握手并生成对称密钥](#225-完成握手并生成对称密钥)
  - [2.3 数据传输](#23-数据传输)
  - [2.4 连接关闭](#24-连接关闭)
- [3. 关键步骤总结](#3-关键步骤总结)
- [4. mbedTLS中的主要模块](#4-mbedtls中的主要模块)
- [5. 编译](#5-编译)

## 1. TLS协议概述
`TLS(Transport Layer Security,传输层安全协议)`是一种加密协议,用于确保数据传输的安全性,防止数据在传输过程中被窃听、篡改或伪造.TLS协议的主要功能包括：
 - 加密：确保数据传输的机密性,防止数据被未授权的第三方读取.
 - 身份验证：通过证书和公钥基础设施(PKI)验证通信双方的身份.
 - 完整性校验：通过消息认证码(MAC)确保数据在传输过程中未被篡改.

### 1.1 TLS连接的基本过程
TLS协议的工作过程大致可以分为以下几个阶段：

1. 握手阶段：双方协商加密算法、生成会话密钥,并验证彼此身份.
2. 数据传输阶段：使用对称加密算法对数据进行加密和解密.
3. 连接关闭阶段：结束TLS会话,安全地关闭连接.

## mbedTLS与远程建立连接的流程

### 2.1 初始化和配置
在使用mbedTLS建立与远程服务器的TLS连接之前,需要完成一系列初始化和配置操作,主要包括：

 - 初始化mbedtls库：mbedTLS库提供了多种功能模块,如SSL/TLS协议、X.509证书、加密算法等.首先需要初始化相关模块.
 - 配置SSL上下文：为TLS连接创建并配置ssl_config结构,指定支持的加密算法、协议版本等参数.
 - 加载证书和私钥：客户端通常需要加载CA证书,以便验证服务器的身份；如果是双向认证,客户端还需要加载自己的证书和私钥.

### 2.2 握手过程
TLS握手过程用于建立安全的通信通道,确保双方能够进行加密通信,并验证彼此的身份.握手阶段通常包括以下步骤：

#### 2.2.1 客户端发起连接
客户端通过网络连接到服务器,通常是通过TCP/IP连接.mbedTLS在底层使用`mbedtls_net_connect`函数来连接到服务器的IP地址和端口.

#### 2.2.2 客户端发送ClientHello消息
客户端向服务器发送ClientHello消息,包含以下内容：

 - 支持的TLS协议版本(如TLS 1.2或TLS 1.3).
 - 支持的加密套件(如RSA、ECDHE等).
 - 客户端生成的随机数(用于后续密钥生成).
  -会话ID(如果是恢复会话时使用).
  -扩展字段(如服务器名称指示SNI等).

#### 2.2.3 服务器响应ServerHello消息
服务器接收到客户端的ClientHello后,选择加密套件并回复ServerHello消息,内容包括：

 - 选择的TLS协议版本.
 - 选择的加密套件.
 - 服务器生成的随机数.
 - 服务器的证书(包含公钥等信息).

#### 2.2.4 证书验证和密钥交换
 - 证书验证：服务器会发送其证书(X.509证书),客户端验证证书是否合法(通过CA证书链进行验证).如果客户端信任该证书,继续后续步骤.
 - 密钥交换：根据选择的加密算法,客户端与服务器通过公开的密钥交换协议(如RSA、ECDHE等)生成共享的会话密钥.

#### 2.2.5 完成握手并生成对称密钥
在密钥交换成功后,客户端和服务器基于协商的参数和随机数生成对称密钥(用于加密数据传输).双方通过Finished消息确认握手成功,TLS握手结束.

### 2.3 数据传输
一旦握手阶段完成,客户端和服务器就可以开始加密的通信.在数据传输阶段,使用对称加密算法(如AES)对应用层数据进行加密和解密,以保证数据的机密性和完整性.每一条消息都通过消息认证码(MAC)进行完整性校验,防止数据在传输过程中被篡改.

### 2.4 连接关闭
当通信完成后,客户端和服务器会通过发送`mbedtls_ssl_close_notify`消息来通知对方关闭连接.这个过程确保双方都正常结束连接,释放资源.

## 3. 关键步骤总结
通过上述过程,mbedTLS与远程服务器建立TLS连接的主要步骤包括：

1. 连接初始化：客户端与服务器建立TCP连接,并初始化mbedTLS库.
2. SSL握手：
 - 客户端发送ClientHello消息,选择协议版本、加密算法等.
 - 服务器响应ServerHello消息,选择加密算法,并提供证书供客户端验证.
 - 双方通过密钥交换协议生成共享会话密钥.
3. 数据加密传输：握手成功后,双方使用对称加密和消息认证码(MAC)保护数据的机密性与完整性.
4. 连接关闭：通信结束后,双方通过close_notify消息关闭连接.

## 4. mbedTLS中的主要模块
mbedTLS提供了一些核心模块用于支持TLS连接的建立：

 - mbedtls_ssl：提供TLS连接的上下文,管理TLS会话.
 - mbedtls_ssl_config：配置SSL上下文,指定协议版本、加密算法等.
 - mbedtls_x509_crt：处理X.509证书(用于身份验证和密钥交换).
 - mbedtls_entropy 和 mbedtls_ctr_drbg：生成伪随机数,保证TLS会话的安全性.
 - mbedtls_net：提供网络连接功能,如TCP/IP连接.

## 5. 编译
本工程的编译文档可参考[build](build.md)